# Dyson Sphere Program - 計算ツール テスト計画書

## 1. エグゼクティブサマリ
この文書は、リポジトリ `new_calc`（Dyson Sphere Program 向け生産チェーン計算ツール）の現状実装を調査した上で作成した総合的なテスト計画書です。対象はフロントエンド（React + TypeScript）、計算ロジック（lib）、および Zustand ストアと主要 UI コンポーネントです。

目的：主要ユーザーフローの安定性と計算結果の正確性を検証し、回帰やセキュリティ欠陥を早期に検出すること。

対象環境：ローカル開発環境（Node.js 18+, npm）／ブランチ：develop

前提：各シナリオは「初期（空）ブラウザ状態」から開始する（localStorage と URL パラメータをクリア）。

---

## 2. 実装サマリ（調査結果の要点）
- フレームワーク/言語: React 18 + TypeScript、Vite
- 計算ライブラリ: `decimal.js` を使用（高精度数値処理）
- データ: `public/data/` の XML（Items/Recipes/Machines）をパースして Map 構造で管理
- 状態管理: Zustand（`src/stores/`）
- 計算ロジック: `src/lib/`（`calculator.ts`, `powerCalculation.ts`, `buildingCost.ts` など）
- 主要 UI: `src/components/`（RecipeSelector, ResultTree/ProductionTree, SettingsPanel, PlanManager, StatisticsView, BuildingCostView, ModSettings）
- 国際化: `react-i18next`（`src/i18n.ts`）
- セキュリティ: DOMSanitization（`dompurify`）や XML パースの妥当性チェックが想定される（ModSettings の説明より）

---

## 3. 実地検証での追加発見（UI 実操作より）
実際に `npm run dev` で起動したアプリを操作して確認した差分・重要点を以下に列挙します（テストシナリオに反映済み）。

- 起動時に Welcome モーダル（チュートリアル）が表示される（「スキップ」「次へ」）。テストではこのモーダルの存在と閉じる処理を確認する必要あり。
- レシピを選択すると Settings 側に「目標」用スピンボタン（spinbutton）が表示される（初期値 1、単位: アイテム/秒）。この入力が計算のトリガーになり得る。
- 増産剤（Proliferator）はボタン群で選択（なし / Mk.I / Mk.II / Mk.III）。設備ランク・ベルトランク・スタック数もボタンで選択する UX。
- 「What-if 分析」領域と「クイックアクション」があり、推奨アップグレード（例：Mk.III 増産剤へアップグレード）を提示、個別に「適用」ボタンで変更を反映できる。これらの「適用」操作による再計算を検証する必要あり。
- 保存/読み込み/URL共有ボタンがヘッダに存在。初期は「保存」「URL共有」が disabled（無効）になっている点を確認（プラン有無で有効化される動作を検証する）。
- レシピ一覧は検索ボックス、フィルタタブ（Items/Buildings）、お気に入り（⭐）ボタンを備える。検索とお気に入り追加の振る舞いを検証する。
- Production Tree の各ノードは展開/折りたたみトグル（例: 「折りたたむ」ラベル、展開状態を表す属性）、ノード詳細に電力・ベルト・入力/出力を表示。全展開ボタンは「▼ すべて展開」表記で状態により表示が切替わる。
- 「カスタム設定を使用」スイッチがあり、グローバル設定とノードごとのカスタム設定切替をする UI がある。

---

## 4. テスト範囲（優先度）
- 高: 計算エンジン（正確性）、store の読み込み/永続化、Recipe 選択 → 計算フロー（目標 spinbutton がトリガー）、保存／共有の有効化条件、代替レシピ選択、採掘計算、ノード個別設定、プランエクスポート/インポート
- 中: ProductionTree の展開/折り畳みロジック、SettingsPanel（Proliferator）挙動、PlanManager（保存/復元/URL復元）、What-if/Quick Actions の適用、統計ビュー、電力グラフ、ボトルネック検出
- 低: UI の見た目回帰、アクセシビリティ詳細、E2E の網羅（ただし重要フローは E2E 推奨）

---

## 5. テスト設計（シナリオ）
各シナリオは番号、タイトル、前提（Seed）、手順（番号付き）、期待結果、成功基準／失敗条件を含みます。

### シナリオ 1: 起動時 Welcome モーダルの表示と閉じる操作
- 前提: ブラウザはクリーン
- ステップ:
  1. アプリを起動する
  2. Welcome モーダルが表示されることを確認
  3. 「スキップ」ボタンを押してモーダルを閉じる
  4. 「次へ」ボタンでモーダルのページ切替が機能するか確認
- 期待結果:
  - モーダルの表示／閉鎖が可能
  - モーダルがあることで背後 UI が操作できない（ポップアップの遮蔽）ことを確認
- 成功基準: モーダルが適切に表示・閉鎖できる
- 失敗条件: モーダルが表示されない、閉じられない

---

### シナリオ 2: ゲームデータ読み込みと初期表示（ハッピーパス）
- 前提: ブラウザはクリーン（localStorage と URL パラメータ無し）
- ステップ:
  1. アプリを起動する
  2. ロード画面が表示されることを確認する
  3. 読み込みが完了し、`RecipeSelector` が表示されることを確認する
- 期待結果:
  - ロード中インジケータが表示される
  - 読み込み成功後、`RecipeSelector` に少なくとも 1 件のレシピが表示される
  - エラー表示は出ない
- 成功基準: レシピ一覧が表示される
- 失敗条件: 空リスト、エラーメッセージ、白画面

---

### シナリオ 3: レシピ選択 → 目標数量入力（spinbutton）→ 計算結果表示（ハッピーパス）
- 前提: データ読み込み完了
- ステップ:
  1. `RecipeSelector` から任意のレシピ（例: 鉄インゴット）を選択する
  2. Settings パネルに「目標」スピンボタンが表示されることを確認（初期 1）
  3. 目標数量に `10` を入力する（items/sec）
  4. `calculateProductionChain` が実行され、`ProductionTree` が表示されることを確認する
- 期待結果:
  - 計算中は計算中表示（UI、もしくはコンソール）
  - ルートノードと子ノードがツリーとして表示される
  - `StatisticsView` や `BuildingCostView` へ切替可能
- 成功基準: ツリーが期待されるノードを持ってレンダリングされる
- 失敗条件: 計算例外、ツリーが空、UI のクラッシュ

---

### シナリオ 4: Proliferator（増産剤）と設備ランクの反映検証
- 前提: レシピ選択済み、目標数量 > 0
- ステップ:
  1. `SettingsPanel` で増産剤を `増産剤 Mk.I` に設定して再計算
  2. `増産剤 Mk.II` / `Mk.III` に切替えてそれぞれ再計算
  3. 設備ランク（溶鉱炉 / 組立機 / 化学プラント / マトリックスラボ）を切替えて再計算
- 期待結果:
  - 増産剤や設備ランクの切替で出力量／必要マシン数／電力が変化する
  - 増産剤は排他（同時に複数モードが有効にならない）であること
- 成功基準: 切替が計算に反映される
- 失敗条件: モード切替が反映されない、両方有効化される

---

### シナリオ 5: Production Tree の展開/折り畳みと全展開/全折り畳み
- 前提: Production Tree が表示されている
- ステップ:
  1. ルートノードの「折りたたむ/展開」トグルを押して表示切替を確認
  2. 「▼ すべて展開」ボタンを押して全展開を確認
  3. 全展開ボタンを再度押して折り畳まれることを確認
- 期待結果:
  - 個別トグルと全体トグルが期待通りに動作する
  - ノード詳細に電力・ベルト・入力/出力が表示される
- 成功基準: ノード表示状態が UI 表示と一致
- 失敗条件: 表示崩れ、ボタン非反応

---

### シナリオ 6: What-if 分析とクイックアクションの適用
- 前提: レシピ選択済み
- ステップ:
  1. What-if セクションに表示される改善提案（例: 増産剤Mk.III にアップグレード）を確認
  2. 「適用」ボタンを押して設定が反映されるか確認
  3. 適用後に計算結果（電力・施設数・ベルト等）が更新されることを確認
- 期待結果:
  - 適用ボタンで設定が変更され、再計算が走る
- 成功基準: What-if の提案が反映され、UI と数値が更新される
- 失敗条件: 適用が反映されない、計算が走らない

---

### シナリオ 7: 保存 / 読み込み / URL共有の状態検証
- 前提: 初期状態とプラン作成後の両方で検証
- ステップ:
  1. 起動直後はヘッダの「💾 保存」「🔗 URL共有」が無効（disabled）であることを確認
  2. レシピ選択＋目標設定を行いプランが生成された後、保存ボタンが有効になるか確認
  3. 保存 → 読み込み → URL 共有 の基本フローを実行して復元を確認
- 期待結果:
  - プランが存在しないときは保存・共有が無効、プラン生成後は有効化される
  - 保存/復元でプラン情報が再現される
- 成功基準: 保存と復元の整合性
- 失敗条件: ボタンが有効化されない、保存/復元で情報が失われる

---

### シナリオ 8: ModSettings（ショートカット Ctrl+Shift+M）とカスタム XML アップロード
- 前提: ModSettings にアクセス可能
- ステップ:
  1. ModSettings をショートカットで開けることを確認（Ctrl+Shift+M）
  2. 10MB を超えるファイルをアップロードして拒否されることを確認
  3. 不正な XML をアップロードして適切にエラーハンドリングされることを確認
  4. 有効なカスタム Recipes.xml をアップロードし、データが置換され、再計算が可能かを確認
- 期待結果:
  - サイズ制限と XML 妥当性チェックが働く
  - 悪意あるコンテンツはサニタイズされる
- 成功基準: 不正ファイルは弾かれ、正常ファイルは反映
- 失敗条件: パース時クラッシュ、セキュリティ問題

---

### シナリオ 9: 検索とお気に入り（RecipeSelector）の検証
- 前提: RecipeSelector が表示されている
- ステップ:
  1. 検索ボックスに文字列を入れ、該当レシピがフィルタされることを確認
  2. 各アイテムの「⭐ お気に入り」ボタンを押してお気に入り登録/解除ができることを確認
  3. 「⭐ お気に入り」フィルタタブでお気に入りのみが表示されることを確認
  4. フィルタタブ（Items / Buildings）切替が働くことを確認
  5. ページをリロードしてお気に入りが永続化されているか確認
- 期待結果:
  - 検索とお気に入りの UI が機能する
  - お気に入りは localStorage に保存され、再起動後も維持される
- 成功基準: 検索結果とお気に入り状態が整合する
- 失敗条件: 検索が機能しない、お気に入りが永続化されない

---

### シナリオ 10: 境界値・大規模値の入力（数値精度・パフォーマンス）
- 前提: レシピ選択済み
  - 極大値の検証は一番計算が多いと思われる `宇宙マトリックス` を選択する
- ステップ:
  1. 目標数量に極大値（例: 1e9）を入力して再計算
  2. 極小値（例: 1e-6）を入力して再計算
  3. 結果の表示（丸め、科学表記、精度）を確認
- 期待結果:
  - decimal.js により精度が保たれる
  - 計算は大幅な遅延やクラッシュを起こさない（目安: 1 秒以内/操作）
  - 表示フォーマットが安定している
- 成功基準: 計算成功、UI 安定
- 失敗条件: 例外、UI フリーズ、破綻した数値表示

---

### シナリオ 11: 設定永続化とロケール反映（基本）
- 前提: 初期状態（localStorage クリア、URL パラメータ無し）
- ステップ:
  1. 言語を日本語→英語に切替
  2. Proliferator やデフォルトマシンなど設定を変更
  3. ページ再読み込み
  4. 設定が復元されているか、`document.documentElement.lang` が更新されているか確認
- 期待結果:
  1. localStorage 経由で設定が復元される
  2. HTML lang 属性が正しく設定される
- 成功基準: 設定とロケールが再起動後も反映
- 失敗条件: 設定が失われる、言語が反映されない

---

### シナリオ 11A: 言語切替 — 設定エリアのアイテム名が翻訳されること（再現テスト）
- 背景/問題点: QA より、設定エリア（Settings パネル）内に表示される選択中アイテム名が言語切替で変わらない不具合が報告されています（添付スクリーンショット参照）。
- 前提: 初期状態。Recipe を一つ選択して Settings パネルが表示されること（例: `重力マトリックス` を選択）。
- ステップ:
  1. アプリを起動してデータ読み込みを完了する
  2. `RecipeSelector` で任意のレシピ（例: 重力マトリックス）を選択する
  3. Settings パネルを開き、表示される選択中アイテム名（ルートレシピ名）を確認してスクリーンショットを取得
  4. UI の言語切替コントロール（例: ヘッダの言語選択）で言語を英語に変更する
  5. Settings パネルのアイテム名が英語表記に変わることを確認し、変更されていない場合はログ／スクリーンショットを取得
  6. ページを再読み込みしても英語表記が維持されることを確認
- 期待結果:
  - Settings パネル内のアイテム名（ルートレシピ名）は言語切替に応じて正しく翻訳される
  - ページ再読み込み後も `document.documentElement.lang` と合わせて翻訳状態が復帰する
  - 変化がない場合、i18n の key（例: items.<sid>.name）を参照し、該当レンダリング箇所が translation 関数を用いているかをデベロッパーツールで確認
- 成功基準: アイテム名が翻訳される
- 失敗条件: アイテム名が翻訳されない、言語切替が UI に反映されない

---

### シナリオ 11B: 言語切替 — 生産チェーンのルートノード名とその入力アイテム名（トップノードのみ）が翻訳されること
- 背景/問題点: QA より、生産チェーン（Production Tree）でルートノードのアイテム名とその入力アイテム名が言語切替で翻訳されず、子ノードは正しく翻訳される、という症状が報告されています（添付スクリーンショット参照）。
- 前提: 初期状態。任意の重めのレシピ（例: 重力マトリックス）を選択し、Production Tree を表示していること。
- ステップ:
  1. アプリを起動してデータ読み込みを完了する
  2. `RecipeSelector` で対象のレシピ（重力マトリックス）を選択し、目標を 1 に設定して Production Tree を表示
  3. ルートノードのアイテム名（ノードタイトル）と、そのルートノードが表示する「入力」リストにある最上位の入力アイテム名を確認しスクリーンショットを取得
  4. 言語を英語に切替
  5. ルートノードの表示（ノードタイトル）とルートノードの入力リストの最上位アイテム名が英語に変わるか確認
  6. 変化がない場合は、子ノード（ルートの一つ下のノード）のアイテム名と比べて差分ログを取る（どのノードで翻訳処理が走っているかを特定）
  7. ページ再読み込み後も同様の状態が維持されるか確認
- 期待結果:
  - ルートノードのタイトル（アイテム名）と、ルートノードに表示される最上位入力アイテム名が言語切替に連動して翻訳される
  - もし子ノードのみが翻訳される実装ミスであれば、該当ノードのレンダリング関数で i18n の翻訳キー参照が欠落している可能性が高い
- 成功基準: ルートノードおよびその入力アイテム名が翻訳される
- 失敗条件: ルートだけ翻訳されない、または入力リストの最上位だけが翻訳されない

---

## 追加: 言語切替に関する回帰チェックリスト（QA 用）
以下は今回の不具合に類似する UI 項目の一覧と確認ポイントです。これらを横断的に確認して未翻訳や静的テキスト参照の箇所を洗い出してください。

- 設定領域（SettingsPanel）
  - 目標（spinbutton）のラベル、選択中レシピ名、マシン/ベルトラベル
- Production Tree（ResultTree / RecipeTree）
  - ルートノードタイトル、子ノードタイトル、入力/出力ラベル、電力・ベルトラベル
- RecipeSelector / RecipeGrid
  - アイテムカードのタイトル、サブテキスト（カテゴリ）、お気に入りツールチップ
- AlternativeRecipeSelector / RecipeComparisonModal
  - モーダルタイトル、テーブルヘッダ、ボタンラベル（Apply / Cancel）
- StatisticsView / PowerGraphView / BuildingCostView
  - 各列ヘッダ、単位ラベル（items/sec、MW 等）
- PlanManager（保存/読み込みダイアログ）
  - ファイル名、ヘルプテキスト、バージョン不一致ワーニング
- ModSettings（アップロード周り）
  - ファイル選択・エラーメッセージ
- ヘッダ／フッタ
  - 言語切替ドロップダウン自体、および言語名リスト（日本語表示と英語表示の両方で意図通りか）

チェック方法: 各箇所で言語を切替→UI を確認→期待した翻訳キーが参照されていない箇所はコンポーネントソースで t('...') 呼び出し有無を確認。

---

## 自動化テスト例（Playwright / E2E の設計メモ）
以下は今回の不具合回帰を自動で検出するための Playwright テスト設計メモ（擬似ステップ）です。実装は `tests/e2e/locale-language-switch.spec.ts` のようなファイル名で追加することを推奨します。

- テスト: settings-item-name-changes-on-language-switch
  1. 起動（ブラウザローカルストレージをクリア）
  2. レシピ `重力マトリックス` を選択
  3. Settings パネルのルートアイテム名のテキストを取得（例: 日本語）
  4. 言語を英語に切替（UI 操作）
  5. Settings パネルのルートアイテム名が英語になっていることを assert

- テスト: production-root-node-name-translates-on-language-switch
  1. 起動・レシピ選択・Production Tree 表示
  2. ルートノードタイトルとルートの入力リストの最上位アイテム名を取得（日本語）
  3. 言語を英語に切替
  4. 上記 2 箇所が英語になっていることを assert

備考:
- Playwright では i18n の遅延ロードやハイドレーションのタイミング差で翻訳反映が遅れる場合があるため、切替後に明示的な待機（例: 言語選択完了のトグル要素の属性変化、あるいは `document.documentElement.lang` の変化）を待ってからアサーションすること。
- 失敗時は DOM の innerHTML をログとして保存し、どの属性（data-i18n-key 等）が欠落しているかを開発へ報告する。

---

---

### シナリオ 12: データ不整合時のエラーハンドリング
- 前提: public/data の一部を意図的に破壊（テスト用）
- ステップ:
  1. Items/Recipes の一部を欠損させて読み込みを試行
  2. UI とコンソールのエラー表示を確認
- 期待結果:
  - ユーザーに対して明示的なエラーメッセージが表示される
  - アプリがクラッシュせず、可能ならフォールバックを行う
- 成功基準: 明確なエラー表示とログ
- 失敗条件: 未処理例外、白画面

---

### シナリオ 13: アクセシビリティとキーボード操作
- 前提: 任意の画面
- ステップ:
  1. Tab キーで主要要素にフォーカス移動できるか確認
  2. Enter/Space でボタン操作が可能か確認
  3. ModSettings のショートカット（Ctrl+Shift+M）が動作するか確認
- 期待結果:
  - キーボードのみで主要機能を操作可能
  - 画像やアイコンに適切な代替テキストがある
- 成功基準: キーボード操作で主要機能が利用可能
- 失敗条件: フォーカス欠如、ショートカット非動作

---

### シナリオ 14: 代替レシピの選択と比較（AlternativeRecipeSelector / RecipeComparisonModal）
- 前提: レシピ選択済みで、代替レシピのある素材が含まれている（例: グラフェン、結晶シリコン等）
- ステップ:
  1. Production Tree の下部またはサイドパネルに AlternativeRecipeSelector が表示されることを確認
  2. 代替レシピのあるアイテム（例: グラフェン）の「比較」ボタンをクリック
  3. RecipeComparisonModal が開き、複数レシピの詳細（消費電力・マシン数・入力/出力・効率スコア）が表形式で表示される
  4. 採掘可能な素材の場合、「採掘」オプションと「レシピ生産」が比較できることを確認
  5. 任意のレシピを選択して「適用」ボタンをクリック
  6. モーダルが閉じ、Production Tree が再計算され、選択したレシピが反映される
  7. ESC キーでモーダルを閉じられることを確認
- 期待結果:
  - 代替レシピが正しく列挙される
  - 比較モーダルで各レシピの電力・マシン数・効率が正確に表示される
  - レシピ選択後、計算結果が更新される
- 成功基準: レシピ切替が計算に反映され、比較情報が正確
- 失敗条件: モーダルが開かない、レシピ選択が反映されない、計算エラー

---

### シナリオ 15: 採掘計算機（MiningCalculator）の表示と設定反映
- 前提: 原材料（鉄鉱石、銅鉱石、水素等）を含むレシピを選択済み
- ステップ:
  1. StatisticsView または専用タブで MiningCalculator セクションが表示されることを確認
  2. 必要な原材料（例: 鉄鉱石）と必要量（items/sec）が表示される
  3. 採掘速度ボーナス（研究レベル）を 100% → 150% → 200% に変更
  4. 必要な採掘機数・鉱脈数が再計算されることを確認
  5. 採掘機タイプを「Mining Machine」→「Advanced Mining Machine」に変更
  6. Advanced Mining Machine の作業速度を 100% → 200% に変更
  7. 電力消費が速度の2乗に比例して増加することを確認（100% → 200% で 4 倍）
  8. 水素や重水素の場合、軌道コレクターの数が表示されることを確認
- 期待結果:
  - 各設定変更が採掘必要量（採掘機数・鉱脈数）に正確に反映される
  - 電力消費が速度の2乗に比例する（ゲーム内検証済みの公式）
  - 軌道コレクターの計算が正しい
- 成功基準: 採掘計算が正確で、設定変更が反映される
- 失敗条件: 計算が不正確、設定が反映されない、電力計算が間違っている

---

### シナリオ 16: ノード個別設定（NodeSettingsModal）のオーバーライド
- 前提: Production Tree が表示されている
- ステップ:
  1. 任意のノード（例: 鉄インゴット）の設定ボタン（歯車アイコン等）をクリック
  2. NodeSettingsModal が開く
  3. 初期状態では「カスタム設定を使用」がオフで、グローバル設定が表示されている
  4. 「カスタム設定を使用」スイッチをオンにする
  5. 増産剤を Mk.III に設定
  6. マシンランクを最高ランク（例: 負エントロピー溶鉱炉）に設定
  7. 「保存」ボタンをクリックしてモーダルを閉じる
  8. 該当ノードの計算結果（マシン数・電力・出力量）が更新されることを確認
  9. 他のノードはグローバル設定のまま変化していないことを確認
  10. ノード設定を開き、「カスタム設定をクリア」でグローバル設定に戻ることを確認
- 期待結果:
  - ノード固有設定がグローバル設定をオーバーライドする
  - 該当ノードのみが変更され、他のノードに影響しない
  - カスタム設定のクリアが機能する
- 成功基準: オーバーライド設定が保存・反映され、他ノードに影響しない
- 失敗条件: 設定が反映されない、他ノードに影響する、クリアが機能しない

---

### シナリオ 17: プランのエクスポートとインポート（JSON ファイル）
- 前提: プラン作成済み（レシピ選択・目標設定・増産剤設定・代替レシピ選択・ノードオーバーライド含む）
- ステップ:
  1. ヘッダの「💾 保存」ボタンをクリック
  2. ドロップダウンメニューから「JSON としてエクスポート」を選択
  3. JSON ファイル（`Plan_YYYY-MM-DD_HH-MM.json` 形式）がダウンロードされる
  4. ファイル内容を確認し、recipeSID、targetQuantity、settings、alternativeRecipes、nodeOverrides が含まれていることを確認
  5. ブラウザをリフレッシュして初期状態に戻す
  6. 「📂 読み込み」ボタンをクリック
  7. ダウンロードした JSON ファイルをアップロード
  8. プランが完全に復元される（レシピ・目標・設定・代替レシピ・ノードオーバーライド）
  9. Production Tree が再計算され、元の状態と一致することを確認
  10. 不正な JSON ファイル（構文エラー、バージョン不一致）をアップロードしてエラーハンドリングを確認
- 期待結果:
  - エクスポートされた JSON に全情報が含まれる
  - インポート時に Map 型（alternativeRecipes, nodeOverrides）が Object から正しく変換される
  - エクスポートとインポートでプランが完全一致
  - 不正ファイルは適切なエラーメッセージで弾かれる
- 成功基準: 完全復元、エラーハンドリングが適切
- 失敗条件: 復元で情報が欠損、不正ファイルでクラッシュ

---

### シナリオ 18: 統計ビュー（StatisticsView）と電力グラフ（PowerGraphView）の表示
- 前提: Production Tree が表示されている
- ステップ:
  1. タブボタンで「統計」タブに切替
  2. StatisticsView が表示され、全アイテムの生産量・消費量集計がリスト形式で表示される
  3. アイテムごとの純生産量（生産 - 消費）が正しく計算されていることを確認
  4. 「電力グラフ表示」トグルボタンをクリック
  5. PowerGraphView が展開され、Chart.js を使った電力消費グラフが描画される
  6. グラフにマシンタイプごとの電力消費が色分けで表示されることを確認
  7. 再度トグルボタンをクリックしてグラフが非表示になることを確認
- 期待結果:
  - 統計データが正確に集計される（全ノードの入出力を再帰的に集計）
  - 電力グラフが正しく描画される
  - トグル操作が機能する
- 成功基準: データ集計が正確、グラフが描画される
- 失敗条件: 集計が不正確、グラフが表示されない

---

### シナリオ 19: ボトルネック検出と一括修正（WhatIfSimulator）
- 前提: ベルト飽和度が 80% を超えるボトルネックが発生するプラン（例: 低ランクベルトで高出力レシピ）
- ステップ:
  1. What-if セクションでボトルネック検出結果が表示されることを確認
  2. 「⚠️ ボトルネック検出 (N)」と表示され、問題箇所が列挙される
  3. 各ボトルネックの重要度（HIGH / MEDIUM / LOW）と推奨改善案を確認
  4. 個別の改善提案（例: 増産剤 Mk.III、ベルト Mk.III へのアップグレード）を確認
  5. 「🔧 すべて修正」ボタンをクリック
  6. すべての提案が設定に一括適用され、再計算される
  7. ボトルネックが解消されたことを確認（飽和度 < 80%）
  8. 最適化目標（⚡ 電力最小化 / 🏭 施設数最小化 / 📈 効率最大化 / ⚖️ バランス）を選択
  9. シナリオが選択した目標に応じてソート/優先表示されることを確認
- 期待結果:
  - ボトルネックが正確に検出される（ベルト飽和度 > 80%）
  - 改善提案が実用的で適切
  - 一括修正でボトルネックが解消される
  - 最適化目標に応じたシナリオのランク付けが機能する
- 成功基準: ボトルネック検出と修正が機能し、最適化目標が反映される
- 失敗条件: 検出が不正確、修正が反映されない、最適化目標が機能しない

---

### シナリオ 20: テンプレート設定（プリセット）の適用
- 前提: レシピ選択済み
- ステップ:
  1. Settings パネルの「🎮 テンプレート」セクションを確認
  2. 「🌱序盤」ボタンをクリック
  3. 設定が序盤用（増産剤なし、基本マシン、低ランクベルト）に一括変更される
  4. Production Tree が再計算され、結果が更新される
  5. 「⚙️中盤」ボタンをクリックし、設定が中盤用に変更されることを確認
  6. 「🚀後半」ボタンをクリックし、設定が後半用に変更されることを確認
  7. 「⭐終盤」ボタンをクリックし、設定が終盤用（増産剤 Mk.III、最高ランクマシン）に変更されることを確認
  8. 「💡省電力」ボタンをクリックし、設定が電力最小化用に変更されることを確認
  9. 各テンプレートで計算結果（電力・マシン数・ベルト数）が異なることを確認
- 期待結果:
  - 各テンプレートボタンで設定が一括変更される
  - 再計算が自動的にトリガーされる
  - 各テンプレートが意図した設定（増産剤・マシンランク・ベルトランク・採掘速度）を反映する
- 成功基準: 各テンプレートが期待通りの設定を適用し、計算結果に反映される
- 失敗条件: テンプレートが適用されない、再計算が走らない、設定が不完全

---

## 6. 自動化テスト計画（推奨）
- ツール: Vitest + @testing-library/react（ユニット / コンポーネント）、Playwright（E2E）

優先実装:
1. `src/lib/calculator.ts` のユニットテスト（高優先）
   - 小規模 / 中規模 / 大規模チェーンの正当性
   - Proliferator の各モードの影響
   - 境界値（非常に大きい数、小さい数）の検証
2. `src/stores/*`（gameDataStore, settingsStore 等）のユニットテスト
3. `ResultTree` のレンダリングと折り畳みロジックのコンポーネントテスト
4. `AlternativeRecipeSelector` と `RecipeComparisonModal` のコンポーネントテスト
5. `MiningCalculator` の計算ロジックと UI のテスト
6. `NodeSettingsModal` のオーバーライド機能のテスト
7. `planExport.ts` と `urlShare.ts` のエクスポート/インポート機能のユニットテスト
8. E2E: レシピ選択→目標設定（spinbutton）→代替レシピ選択→ノード個別設定→計算→プラン保存/復元（Playwright）

サンプルコマンド（ローカル）:
```pwsh
npm install
npm run dev       # 手動確認
npm run test      # vitest
npm run test:coverage
```

---

## 7. 優先的な改善提案（開発向け）
* 計算ロジックのユニットテストを最優先で追加
* Plan のシリアライズ形式と互換性テストを整備
* ModSettings のファイルアップロードに対してサニタイズテストを追加
* 数値表示のフォーマットポリシー（丸めルール）をドキュメント化
* What-if / Quick Actions の適用が UI と内部状態の双方で一貫するかの統合テストを作成
* 代替レシピ選択と採掘計算の正確性検証テストを追加
* ノード個別設定のオーバーライド機能の統合テストを作成
* プランエクスポート/インポートの互換性テスト（バージョン間）を整備

---

## 8. 付録: サンプルユニットテストケース（計算）
* ケース A: レシピ A（1 出力 / 原料 X=2）で目標 10 → 必要原料 X = 20
* ケース B: 上記に Proliferator Production（+20%）適用 → 必要原料 X = 20 / 1.2 = 16.666...（丸めルール確認）
* ケース C: 目標 1e9 の場合、計算がタイムアウトしないか
* ケース D: 代替レシピ選択時、選択したレシピが計算に反映されるか
* ケース E: 採掘計算で Advanced Mining Machine の作業速度 200% 時、電力が 400%（4 倍）になるか

---

作成者: 自動生成（リポジトリ実装の調査に基づく）
作成日: 2025-10-21
更新日: 2025-10-21（シナリオ 14〜20 追加）以下の差分を `docs/TEST_PLAN.md` に追加してください。

---

## 追加: レシピ再選択時の生産チェーン維持テスト

新しいシナリオを別ファイル `docs/TEST_PLAN_RECIPES_ADDITION.md` に追加しました。該当シナリオでは、任意のレシピを選択後に同一レシピを再選択しても生産チェーンが正しく維持されることを検証します。

テスト実行者は新しいファイルを参照し、手順に従って手動または自動（Playwright）で実行してください。

---
