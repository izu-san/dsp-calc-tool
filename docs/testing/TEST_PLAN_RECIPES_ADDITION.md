# レシピ再選択時の生産チェーン維持テスト

## エグゼクティブサマリ

このドキュメントは、レシピ選択UIにおける重要な安定性シナリオ「任意のレシピを選択した後、同じレシピを再度選択しても生産チェーンが正しく表示され続けること」を手順化したテストケースをまとめたものです。

対象ページ／機能:

- レシピ選択コンポーネント（レシピ一覧、レシピ選択ダイアログ／サイドパネル）
- 生産チェーン表示（ResultTree / 生産経路ビュー）

テスト目的:

- 再選択による不具合（チェーン消失、ノード重複、例外発生、UIフリーズ等）が発生しないことを検証する

前提:

- 常に「空の／新規の状態」から開始する（アプリ起動直後、既存の計画が読み込まれていない状態）。
- テストは手動でも自動化（Playwright）でも実行可能。

---

## シナリオ: 同一レシピを再選択しても生産チェーンが維持されること

### 目的

任意のレシピを選択 → 再度同じレシピを選択した際に、生産チェーン表示が正しく維持され、重複や消失、エラーが発生しないことを確認する。

### 前提（Seed）

- ブラウザを起動しアプリにアクセスする（例: ローカル開発環境やステージング環境のトップページ）
- ユーザーは未ログインまたは標準ユーザーとして扱う（権限差による振る舞いの違いは本シナリオでは考慮しない）
- 計画領域（ResultTree 等）は空の状態

### 手順（番号付き）

1. アプリを開き、ホーム／計算画面へ移動する
2. レシピ選択UIを開く（レシピ一覧、もしくは「レシピを追加」ボタンを押す）
3. 任意のレシピを1つ選択する（例: "Iron Ingot"、"Gear Wheel" 等、シンプルな単一出力レシピを推奨）
4. 生産チェーン（ResultTree）が正しく表示されることを確認する
   - 選択したレシピのノードが存在すること
   - 必要な原料ノードや下流ノードがツリーに表示されていること
   - アクティブなUI操作（折りたたみ、詳細表示）が機能すること
5. 再び同じレシピを選択する（同じ場所からもう一度選択する、もしくは候補リストで同レシピをクリック）
6. 再選択後に以下を確認する
   - 生産チェーンが消えていないこと（ツリーが空にならない）
   - 同一ノードが重複して追加されていないこと（意図しない重複がない）
   - UIエラーや例外メッセージが発生していないこと（ブラウザコンソール、UI通知）
   - レスポンス遅延やフリーズが発生していないこと

### 期待結果

- 手順3で表示された生産チェーンが、手順5の再選択後も維持される
- ノードの重複追加やツリーの不整合がない
- エラー表示（例: トースト、モーダル、コンソールエラー）が発生しない
- ユーザー操作（ノード選択、折りたたみ、設定変更等）が通常通り動作する

### 成功判定／失敗条件

成功:

- 上記すべての期待結果が満たされ、ユーザーが継続して生産計画を編集できる
  失敗:
- 生産チェーンが消える、ノードが重複する、UIが応答しない、もしくは例外が発生する

---

## 拡張シナリオ（エッジケース）

### A. 連続で高速に同じレシピを複数回選択する（ダブルクリック／連打）

手順: 手順3→5を素早く連続実行する。期待: UIがレースコンディションや二重登録を起こさない。

### B. 別のレシピを経由して再び元のレシピを選択する

手順: レシピAを選択してチェーンを表示 → レシピBを選択してチェーン更新 → 再度レシピAを選択
期待: レシピAを再選択した際にAのチェーンが正しく復元され、重複や破綻がない。

### C. ネットワーク遅延／失敗が発生している状態で再選択する

手順: 意図的にネットワーク遅延を発生させる（開発ツールで throttling 等）→ 再選択
期待: 遅延があってもUIは整合性を保ち、明確なローディング指標やエラーハンドリングを表示する。

### D. 代替レシピ（alternative recipe）を選んだ後に同一レシピを再選択する

手順: 同一出力を持つ代替レシピを切り替え → 元のレシピを再選択
期待: ツリーの内容が正しく更新され、不要な重複が生じない

---

## 自動化のヒント（Playwright）

- 初期シード: `tests/fixtures/seed.spec.ts` と同様の空状態を用いる
- 検出ポイント:
  - DOM上のResultTreeノードの数比較（再選択前後で一致）
  - コンソールエラーのキャプチャ（playwrightの page.on('console') を利用）
  - レイテンシを測定して閾値を超えないことを確認
- 推奨アサーション:
  - ノードのユニークIDの集合が再選択前後で一致
  - 画面上にエラー通知が表示されないこと

---

## テストデータ例

- レシピ名: 任意（例: "Iron Ingot"）
- 入力数: デフォルトのまま

---

## 備考

- このシナリオは回帰テスト向けに重要です。レシピ選択ロジックやツリーレンダリングへ影響を与える変更（メモ化、キー管理、同一選択時の早期リターン等）が入った場合は必ずこのテストを実行してください。

---

作成日: 2025-10-23
作成者: テストプラン追加自動生成
