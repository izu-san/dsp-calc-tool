---
alwaysApply: false
---

# Pull Requestの作り方

## 自動実行ルール

ユーザーからPR作成を依頼された場合、以下の全ステップを**自動的に実行**すること。

---

## ステップ 1: 前提条件の確認

### 1.1 現在のブランチを確認
```bash
git branch --show-current
```

### 1.2 コミット状態を確認
```bash
git status
```
- 未コミットの変更がある場合は警告し、コミットを促す

### 1.3 プッシュ状態を確認
```bash
git log origin/$(git branch --show-current)..HEAD
```
- プッシュされていないコミットがある場合は、先にプッシュを実行

---

## ステップ 2: マージ先ブランチとの差分確認

### 2.1 マージ先ブランチの決定
現在のブランチ名から作業タイプを自動判定し、マージ先ブランチを決定する：

| 現在のブランチパターン | マージ先ブランチ | 作業タイプ |
|-------------------|--------------|----------|
| `hotfix/fix-*` | `main` | 不具合修正 |
| `feature/refactoring-*` | `develop` | リファクタリング |
| `feature/*` | `develop` | 機能エンハンス |
| その他 | `develop` (デフォルト) | - |

**判定ロジック**:
```bash
current_branch=$(git branch --show-current)

if [[ $current_branch == hotfix/fix-* ]]; then
  base_branch="main"
elif [[ $current_branch == feature/* ]]; then
  base_branch="develop"
else
  base_branch="develop"  # デフォルト
fi
```

- ユーザーから明示的に指定がある場合: その指定に従う（自動判定を上書き）

### 2.2 Issue番号の確認
- ユーザーから Issue 番号の指定があるか確認
- 指定がある場合: Issue番号を記録（例: `#123`）
- 指定がない場合: Issue紐づけなしでPRを作成

### 2.3 差分の統計を確認
```bash
git diff <マージ先ブランチ> --stat
```

### 2.4 コミットログを確認
```bash
git log <マージ先ブランチ>..HEAD --oneline
```

---

## ステップ 3: PRタイトルの生成

以下の形式に従ってタイトルを自動生成する：

| 変更の種類 | タイトル形式 | 例 |
|-----------|------------|-----|
| **リファクタリング** | `refactor: <変更内容>` | `refactor: App.tsxを分割してカスタムフックを抽出` |
| **新機能** | `feat: <機能名>` | `feat: 採掘速度計算機能を追加` |
| **バグ修正** | `fix: <修正内容>` | `fix: 増産剤計算の誤りを修正` |
| **ドキュメント** | `docs: <ドキュメント名>` | `docs: READMEにインストール手順を追加` |
| **テスト** | `test: <テスト内容>` | `test: calculator.tsのテストカバレッジを向上` |
| **スタイル** | `style: <変更内容>` | `style: ESLintエラーを修正` |
| **パフォーマンス** | `perf: <改善内容>` | `perf: メモ化により再計算を最適化` |

**生成方法**:
1. `git log` のコミットメッセージから変更の種類を判定
2. 変更されたファイルから主要な変更内容を抽出
3. 簡潔で分かりやすいタイトルを生成（50文字以内を推奨）

---

## ステップ 4: PR本文の生成

### 4.1 品質保証結果の収集
PR本文生成前に、以下の情報を収集する：

1. **単体テスト結果**: テスト実行時の出力を解析
   - `npm test` の終了コード（0=成功、非0=失敗）を確認
   - 出力から "Tests:" または "Test Suites:" 行を抽出してテスト合格数を取得
   - `npm run test:coverage` 実行後、coverage サマリーからカバレッジ率を取得
   - 例: "All files | 92.5 | 90.2 | 95.3 | 92.5 |" から 92.5% を抽出

2. **E2Eテスト結果**: テスト実行時の出力を解析
   - `npm run test:e2e` の終了コード（0=成功、非0=失敗）を確認
   - 出力から "passed" または "failed" を含む行を抽出
   - 例: "21 passed (13s)" から成功数を取得

3. **ビルド結果**: コマンド実行の終了コードから判定
   - `npm run build` の終了コード
   - 成功: exit code 0 → "✅ success"
   - 失敗: exit code 非0 → "❌ failed"

4. **ESLint結果**: `npm run lint` の出力を解析
   - 出力から "error" と "warning" の数をカウント
   - 例: "0 errors, 2 warnings" から抽出

### 4.2 テンプレート構造
以下のテンプレートに従って、具体的な内容を自動生成する：
```markdown
<1-2行で変更内容を要約>

## 目的

<なぜこの変更が必要か、解決する課題を記載>

## 変更内容

<変更したファイルと内容を箇条書きで記載>
- ファイル名: 変更内容

## 品質保証結果

### 単体テスト
- 実行結果: <passed/failed>
- カバレッジ: <カバレッジ率>

### E2Eテスト
- 実行結果: <passed/failed>
- シナリオ数: <成功数/総数>

### ビルド
- ビルド結果: <success/failed>

### ESLint
- エラー: <エラー数>
- 警告: <警告数>

## 参考

<関連するIssue、ドキュメント、参考URLなどがあれば記載>

---

**Issue番号が指定されている場合**:
- 本文の末尾に以下を追加してIssueを自動クローズ:
  - `Closes #<Issue番号>` (バグ修正、機能実装の場合)
  - `Resolves #<Issue番号>` (問題解決の場合)
  - `Fixes #<Issue番号>` (修正の場合)
  - `Related to #<Issue番号>` (関連するが自動クローズしない場合)

**キーワードの使い分け**:
- `Closes`: 機能実装、タスク完了
- `Fixes`: バグ修正
- `Resolves`: 問題解決
- `Related to`: 関連するが自動クローズしない
```

### 本文生成の具体例（リファクタリングの場合）

```markdown
App.tsxを複数のレイアウトコンポーネントに分割し、カスタムフックを抽出してコードの保守性を向上

## 目的

App.tsxが1000行を超え、保守性が低下していたため、責任を分離し、テスタビリティを向上させる。

## 変更内容

- `src/App.tsx`: メインロジックを300行に削減
- `src/components/Layout/MainLayout.tsx`: レイアウトコンポーネントを抽出
- `src/hooks/useProductionCalculation.ts`: 計算ロジックをカスタムフックに抽出
- `src/components/__tests__/Main.smoke.test.tsx`: スモークテストを追加

## 品質保証結果

### 単体テスト
- 実行結果: ✅ passed (0 failed)
- カバレッジ: 92.5%

### E2Eテスト
- 実行結果: ✅ passed
- シナリオ数: 21/21

### ビルド
- ビルド結果: ✅ success

### ESLint
- エラー: 0
- 警告: 0

## 参考

- リファクタリングガイド: @refactoring.mdc
```

### 本文生成の具体例（Issue番号がある場合）

```markdown
採掘速度計算機能を追加

## 目的

Issue #45 で要望された採掘速度計算機能を実装し、ユーザーが鉱床の採掘効率を簡単に計算できるようにする。

## 変更内容

- `src/lib/miningCalculation.ts`: 採掘速度計算ロジックを実装
- `src/components/MiningCalculator/MiningCalculator.tsx`: UIコンポーネントを追加
- `src/lib/__tests__/miningCalculation.test.ts`: 単体テストを追加
- `src/App.tsx`: MiningCalculatorコンポーネントを統合

## 品質保証結果

### 単体テスト
- 実行結果: ✅ passed (0 failed)
- カバレッジ: 95.2%

### E2Eテスト
- 実行結果: ✅ passed
- シナリオ数: 21/21

### ビルド
- ビルド結果: ✅ success

### ESLint
- エラー: 0
- 警告: 0

## 参考

- 設計ドキュメント: @miningCalculation.mdc

Closes #45
```

---

## ステップ 5: PR作成コマンドの実行

### 5.1 本文をファイルに保存
複数行の本文を扱うため、一時ファイルに保存：

**Issue番号の追加**:
- Issue番号が指定されている場合、PR本文の末尾に以下を追加:
  - バグ修正: `Fixes #<Issue番号>`
  - 機能実装: `Closes #<Issue番号>`
  - 問題解決: `Resolves #<Issue番号>`
  - 関連のみ: `Related to #<Issue番号>`

**AIアシスタント向けの推奨方法（重要）**:

**ステップA: 一時フォルダパスを取得**

AIアシスタントは、まず一時フォルダパスを取得する：

**Windows (PowerShell)**:
```powershell
echo $env:TEMP
```

**Unix/Mac (Bash)**:
```bash
echo $TMPDIR
```

出力例:
- Windows: `C:\Users\YourName\AppData\Local\Temp`
- Unix/Mac: `/tmp` または `/var/folders/...`

**ステップB: 取得したパスでwriteツールを使用**

AIアシスタントは、ステップAで取得した実際のパスを使用して **`write` ツール**でPR本文を作成する：

```
Windows: C:\Users\YourName\AppData\Local\Temp\pr_body.md
Unix/Mac: /tmp/pr_body.md
```

**重要**: `write`ツールでは環境変数（`$env:TEMP`など）を直接使用できないため、必ず実際のパス文字列を使用すること。

これにより、シェルの構文エラーを回避し、確実にPR本文を作成できます。

**代替方法（writeツールが失敗した場合のフォールバック）**:

**Windows (PowerShell)**:
```powershell
# 本文を一時ファイルに保存
@"
<生成したPR本文>
"@ | Out-File -FilePath "$env:TEMP\pr_body.md" -Encoding utf8

# Issue番号がある場合は追記
# Add-Content -Path "$env:TEMP\pr_body.md" -Value "`n`nCloses #<Issue番号>" -Encoding utf8
```

**Unix/Mac (Bash)**:
```bash
# 本文を一時ファイルに保存
cat > /tmp/pr_body.md << 'EOF'
<生成したPR本文>
EOF
# Issue番号がある場合は追加
# echo -e "\n\nCloses #<Issue番号>" >> /tmp/pr_body.md
```

### 5.2 PRを作成

AIアシスタントは、ステップAで取得した一時フォルダパスを使用してPRを作成する：

**Windows (PowerShell)**:
```powershell
gh pr create --base <マージ先ブランチ> --title "<生成したタイトル>" --body-file "<ステップAで取得したパス>\pr_body.md"
```

例:
```powershell
gh pr create --base develop --title "feat: カスタムコマンドを追加" --body-file "C:\Users\YourName\AppData\Local\Temp\pr_body.md"
```

**Unix/Mac (Bash)**:
```bash
gh pr create --base <マージ先ブランチ> --title "<生成したタイトル>" --body-file <ステップAで取得したパス>/pr_body.md
```

例:
```bash
gh pr create --base develop --title "feat: カスタムコマンドを追加" --body-file "/tmp/pr_body.md"
```

### 5.3 一時ファイルを削除

**重要**: `delete_file` ツールはワークスペース内のファイルのみ対応しており、ワークスペース外の絶対パス（一時フォルダなど）には対応していません。

そのため、一時ファイルの削除には **`run_terminal_cmd` ツールでターミナルコマンドを使用**してください：

**Windows (PowerShell)**:
```powershell
Remove-Item "<ステップAで取得したパス>\pr_body.md" -ErrorAction SilentlyContinue
```

例:
```powershell
Remove-Item "C:\Users\YourName\AppData\Local\Temp\pr_body.md" -ErrorAction SilentlyContinue
```

**Unix/Mac (Bash)**:
```bash
rm -f <ステップAで取得したパス>/pr_body.md
```

例:
```bash
rm -f /tmp/pr_body.md
```

**注意**: 削除に失敗しても問題ありません（一時ファイルは自動的にクリーンアップされます）。`-ErrorAction SilentlyContinue` または `-f` オプションにより、エラーが発生しても処理を継続します。

### 5.4 結果を確認
- PR URLが表示されることを確認
- ブラウザで自動的に開かれることを確認

---

## エラーハンドリング

### `gh` コマンドが見つからない場合
```
エラー: GitHub CLI (`gh`) がインストールされていません。
以下のコマンドでインストールしてください：
- Windows: `winget install GitHub.cli`
- Mac: `brew install gh`
- Linux: https://github.com/cli/cli#installation
```

### 認証エラーの場合
```
エラー: GitHub CLIで認証されていません。
以下のコマンドで認証してください：
`gh auth login`
```

### プッシュされていない場合
```
警告: 変更がリモートにプッシュされていません。
先に以下のコマンドを実行してください：
`git push origin <ブランチ名>`
```

### 未コミットの変更がある場合
```
警告: 未コミットの変更があります。
先にコミットしてください：
`git add .`
`git commit -m "..."`
```

---

## Issue紐づけの詳細

### Issueを自動クローズするキーワード

PR本文に以下のキーワードを含めると、PRがマージされたときに自動的にIssueがクローズされます：

| キーワード | 用途 | 例 |
|---------|-----|-----|
| `Closes #123` | 機能実装、タスク完了 | `Closes #45` |
| `Fixes #123` | バグ修正 | `Fixes #78` |
| `Resolves #123` | 問題解決 | `Resolves #92` |

### 複数のIssueを紐づける

複数のIssueに関連する場合：
```markdown
Closes #45, #67
Fixes #78
```

### 関連するが自動クローズしない

関連するが自動クローズしたくない場合：
```markdown
Related to #45
See also #67
```

### 使用例

```markdown
## 参考

- 設計ドキュメント: @miningCalculation.mdc
- 関連PR: #42

Closes #45
```

---

## 重要な注意事項

1. **PRタイトルは具体的に**: 変更内容が一目で分かるようにする
2. **本文は詳細に**: レビュアーが文脈を理解できるように十分な情報を提供
3. **テスト結果は必須**: 品質保証セクションは必ず埋める
4. **差分を確認**: PR作成前に必ず差分を確認し、意図しない変更がないかチェック
5. **ユーザーに報告**: 各ステップの実行結果をユーザーに報告する
6. **OS対応**: ユーザーのOS（Windows/Unix/Mac）を検出し、適切なコマンドを使用する
7. **Issue紐づけ**: Issue番号が指定されている場合、適切なキーワード（Closes/Fixes/Resolves）を使用してPRとIssueを紐づける

---
